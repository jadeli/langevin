// LANGEVIN: 
// Copyright@2018 Yao, Li CCNU

#include <memory>
#include <cmath>
#include "../include/sample.h"

namespace langevin {

namespace {

constexpr double PI = 3.1415926;
constexpr double momentum_cumeks[151] = {0.000000000000000,0.004446385408257,0.012893324539010,0.024536780191462,0.038462532339739,0.053802387966419,0.070591392849825,0.089562435012456,0.110708368119452,0.134086624512994,0.159635190158086,0.187182653766218,0.216481424162109,0.247229497160039,0.279018728339897,0.311441180625594,0.344117676668263,0.376703894817938,0.408897447521682,0.440436884346722,0.471104520468700,0.500744561749854,0.529251415349506,0.556541374634703,0.582568872729174,0.607313541014673,0.630775450820959,0.652971064850143,0.673928673500904,0.693687712262110,0.712290148566871,0.729786725904952,0.746229334686115,0.761670091025713,0.776161844964310,0.789756567520260,0.802505108928658,0.814456435667172,0.825657208564859,0.836150206292489,0.845979413958138,0.855185282130209,0.863806188031601,0.871878472211185,0.879436507163338,0.886512967679481,0.893139150071136,0.899344181464249,0.905155557700414,0.910599335610003,0.915699756717194,0.920479474505457,0.924960011049771,0.929161220863487,0.933101975842560,0.936800063109763,0.940271683367203,0.943531973956956,0.946595140916266,0.949474182270474,0.952181243636270,0.954727564380584,0.957123643369084,0.959378984868918,0.961502845777202,0.963503546612520,0.965388910143467,0.967166303238186,0.968842637229927,0.970424349349621,0.971917406650645,0.973327376901876,0.974659459360715,0.975918473015316,0.977108912370774,0.978234982337412,0.979300612854870,0.980309450748617,0.981264898583384,0.982170174237477,0.983028219169247,0.983841825970069,0.984613591476870,0.985345957324777,0.986041185207667,0.986701420989459,0.987328648050806,0.987924750497041,0.988491469961747,0.989030446434277,0.989543217632678,0.990031241082363,0.990495891928885,0.990938417821670,0.991360027507121,0.991761867697233,0.992144978147514,0.992510357958586,0.992858964652100,0.993191647135039,0.993509258236791,0.993812585090290,0.994102372260427,0.994379299097932,0.994644047581999,0.994897210260624,0.995139381549136,0.995371112545201,0.995592927448139,0.995805311862407,0.996008731927645,0.996203627990234,0.996390413384176,0.996569479845043,0.996741200284375,0.996905924698620,0.997063985126875,0.997215700665508,0.997361365998805,0.997501264432048,0.997635658001532,0.997764797255661,0.997888916427914,0.998008237880117,0.998122976149167,0.998233332741411,0.998339502219451,0.998441665311515,0.998539996954165,0.998634664226249,0.998725823751921,0.998813624853794,0.998898213876837,0.998979723685620,0.999058296689429,0.999134045766632,0.999207086209168,0.999277533312527,0.999345491510928,0.999411065888815,0.999474352997900,0.999535444535073,0.999594432781533,0.999651401505914,0.999706433155859,0.999759603886445,0.999810986590270,0.999860654657098,0.999908669112363,0.999955097400987,0.99999999999999999};
constexpr double momentum_cum[151] = {0,0.00530295254970338,0.0153953739350929,0.0292968709855887,0.0458714773444432,0.0640842677679623,0.0839281418589982,0.106210051281505,0.1308511787499,0.157991805861139,0.187503604365829,0.218961925118029,0.252013059004538,0.286255477128032,0.321187445796859,0.356237889755149,0.390982728911755,0.425058094287587,0.458334407630871,0.490475447073968,0.521445202318153,0.551180648946778,0.579591997786369,0.606614395772297,0.632162443125631,0.656245398176015,0.678944718879021,0.700248250480052,0.720165136219022,0.738806843699417,0.756198059668999,0.772414011253062,0.787528170458474,0.801611508647953,0.814704971551616,0.826904559991592,0.838248567199341,0.848799109022006,0.858613880582198,0.867746318682407,0.876228713345733,0.884110069780551,0.891435700093576,0.898247464978302,0.904584021797318,0.910481236987184,0.915961536741485,0.921057121888781,0.925788159027561,0.930192369137559,0.93429482707469,0.938118533522122,0.941677743941775,0.944999521364705,0.948101947347069,0.951001773199527,0.953714086866401,0.95625278223603,0.958630710355897,0.960859508716184,0.962949915188993,0.964915622255632,0.966761604030429,0.96849942831034,0.970133339700631,0.971673353981237,0.973122841650902,0.974490559663635,0.975779401055635,0.976994637384249,0.978143323266487,0.979229703978974,0.980257726524106,0.981229190873342,0.982147689808456,0.983016567197705,0.983838932893558,0.984617660814529,0.985356807809771,0.986057428069271,0.98672305977112,0.987354568166325,0.987955085613791,0.988525332223583,0.989067059661441,0.989581925986786,0.990071460166722,0.990537969206922,0.990981891791083,0.991404488567386,0.991806939972861,0.992189664742319,0.99255444855691,0.992901610982458,0.993232736932468,0.993548125959938,0.993848622056246,0.994135034046459,0.994408632137601,0.994669582570395,0.994918572334642,0.995156666905515,0.995384014397107,0.995601161869283,0.995808656381907,0.996007333678259,0.99619729519715,0.996378982915125,0.996552817593855,0.996719489023655,0.996879056558859,0.997031872648985,0.997178268490318,0.997318557568107,0.997453037427677,0.997581987903321,0.997705674660505,0.997824350966974,0.997938457977661,0.998048006811513,0.998153206835936,0.998254256772536,0.998351342922817,0.998444642716787,0.998534326487249,0.998620553921209,0.99870347938277,0.998783390314936,0.998860275947226,0.998934269591913,0.999005495673787,0.999074073285147,0.999140117963296,0.999203736358055,0.999265031564248,0.999324103121706,0.999381043460275,0.999435943232298,0.999488885980137,0.999540047097346,0.999589407932995,0.9996371270136,0.999683188859594,0.999727659474936,0.999770681826653,0.999812236979285,0.999852382119642,0.999891174434534,0.999928663962419,0.999964902528843,0.999999999999999};
constexpr double momentum_cum1[151] = {0,0.00635284743511901,0.0183728986692585,0.0348335698871353,0.0543463347765591,0.0756038994713688,0.0985683903230941,0.124137021004115,0.152176580750848,0.182636136036038,0.21530803478704,0.249854026143377,0.285858805959757,0.322865278478779,0.360319704840053,0.397704913843777,0.434571645659823,0.470541163803489,0.505307867111256,0.538632759801399,0.570340839498228,0.600334157110872,0.628573533002981,0.655045907295775,0.679777399746816,0.702817637895482,0.724233227123564,0.744102526703759,0.762510425848156,0.779547037720355,0.795299863508203,0.8098590163753,0.823310691521613,0.835736643788323,0.847214840651763,0.857818417433117,0.867615807897207,0.876670483054917,0.885040951163195,0.892781018922626,0.899940444471373,0.90656519858275,0.912697595264015,0.91837655295394,0.923637855720391,0.928514545056687,0.933037311677968,0.93723410372483,0.941130649158474,0.944750716958287,0.948115986523046,0.951246308868502,0.954160098423739,0.956874071833598,0.959403770353832,0.961763559851101,0.963966369605401,0.966024084106424,0.967947673652346,0.969747063751044,0.971431396317666,0.973009029674631,0.974487669150423,0.975874236480796,0.977175353024293,0.978396934906002,0.979544480334892,0.980623108783444,0.981637574047537,0.982592264246441,0.983491214882699,0.984338161081644,0.985136563711154,0.98588960938165,0.986600249625739,0.987271227017964,0.987905088234689,0.988504184054094,0.989070695475935,0.989606672901182,0.990113983892501,0.990594391533528,0.991049528309109,0.991480922225064,0.991889983748299,0.992278044986452,0.992646333568128,0.992996011822538,0.993328150659743,0.993643755690409,0.993943767225808,0.994229073337698,0.99450050985832,0.994758834260645,0.995004777897883,0.99523903294361,0.995462226272009,0.995674958637502,0.995877804674757,0.996071273719046,0.996255875105641,0.996432078990179,0.996600329408538,0.996761031216961,0.99691458927169,0.997061356189451,0.997201684586972,0.997335900961224,0.997464316137319,0.997587217432593,0.997704880410487,0.997817564962589,0.997925515308632,0.998028962608471,0.998128126268069,0.998223212633511,0.998314417602978,0.998401927932738,0.998485917319179,0.99856655162276,0.998643984950051,0.998718363571695,0.998789824616419,0.99885849868301,0.998924511146306,0.998987979545215,0.999049017500682,0.999107730797726,0.999164221303401,0.999218586966799,0.999270919207069,0.999321305525401,0.999369830811007,0.999416573423158,0.999461609109153,0.999505011004312,0.999546847020005,0.999587183761614,0.999626082610568,0.999663604948299,0.999699806932285,0.999734742108029,0.999768464021034,0.999801020992852,0.999832461345034,0.999862829481168,0.999892167192865,0.999920516271739,0.99994791328545,0.999974396107646,0.999999999999999};
constexpr double temp_cum[187] = {419.987981,409.9990049,400.5426928,	391.5792287,383.0726459,374.9903865,367.3028981,359.9832974,	353.007019,346.3517828,339.9970323,333.9239667,328.1153125,	322.5551638,317.2288582,312.1228504,307.22461,302.5227966,	298.0054264,293.6642308,289.4891135,285.4714065,281.6030243,	277.8764102,274.2845053,270.8207054,267.4788258,264.2530534,	261.1379339,258.1283465,255.2194734,252.4071071,249.6864197,	247.0534216,244.5044765,242.0359811,239.6445292,237.326947,	235.0800854,232.9010992,230.7871522,228.735814,226.7445229,	224.810927,222.9327845,221.107964,219.3344391,217.6102787,	215.9336342,214.3027436,212.7159304,211.171593,209.6681942,	208.2042634,206.778401,205.3892645,204.0355625,202.7160612,	201.429581,200.1749862,198.9511858,197.7571373,196.5918372,	195.4543176,194.3436538,193.2589546,192.1993589,191.1640452,	190.15222,189.1631103,188.1959826,187.2501287,186.3248534,	185.4194857,184.533413,183.6659994,182.81665,181.9847908,	181.1698596,180.3712661,179.5885977,178.8212939,178.0688679,	177.3308487,176.6067754,175.8962101,175.1987237,174.5138954,	173.8412334,173.1805231,172.5313025,171.8931968,171.2658515,	170.6489221,170.0420705,169.4449522,168.8572624,168.2786919,	167.7089465,167.1477296,166.5947534,166.0497482,165.5124424,	164.9825689,164.4598547,163.9441003,163.4350331,162.9324214,	162.4360375,161.9456527,161.4610592,160.9820426,160.5083913,	160.0399098,159.5764008,159.1176681,158.6635305,158.2138401,	157.7683415,157.3269052,156.8893569,156.4555368,156.0252936,	155.5984555,155.1748845,154.7544195,154.3369191,153.922239,	153.5101881,153.1007247,152.6936653,152.2888784,151.8862371,	151.4856125,151.0868954,150.6899656,150.2947068,149.9010136,	149.5087648,149.1178621,148.7281412,148.3395792,147.9519401,	147.5653299,147.179549,146.7943796,146.409988,146.0262206,	145.6429215,145.2594179,144.876741,144.4943414,144.112042,	143.7298158,143.3475846,142.9652741,142.5828184,142.2001369,	141.8171766,141.4338723,141.0501498,140.6659734,140.2812505,	139.8959498,139.5099797,139.1232983,138.7358309,138.3475248,	137.9583285,137.5681801,137.1770939,136.7849624,136.391737,	135.9973705,135.601823,135.2049178,134.8068887,134.4075545,	134.0068434,133.6047815,133.2013142,132.7965805,132.3902668,	131.9824659,131.5731009,131.1626973,130.7501533};
constexpr double vlo_cum[100] = {0.05,0.059494949,0.068989899,	0.078484848,0.087979798,0.097474747,0.106969697,0.116464646,	0.125959596,0.135454545,0.144949495,0.154444444,0.163939394,	0.173434343,0.182929293,0.192424242,0.201919192,0.211414141,	0.220909091,0.23040404,0.23989899,0.249393939,0.258888889,	0.268383838,0.277878788,0.287373737,0.296868687,0.306363636,	0.315858586,0.325353535,0.334848485,0.344343434,0.353838384,	0.363333333,0.372828283,0.382323232,0.391818182,0.401313131,	0.410808081,0.42030303,0.42979798,0.439292929,0.448787879,	0.458282828,0.467777778,0.477272727,0.486767677,0.496262626,	0.505757576,0.515252525,0.524747475,0.534242424,0.543737374,	0.553232323,0.562727273,0.572222222,0.581717172,0.591212121,	0.600707071,0.61020202,0.61969697,0.629191919,0.638686869,	0.648181818,0.657676768,0.667171717,0.676666667,0.686161616,	0.695656566,0.705151515,0.714646465,0.724141414,0.733636364,	0.743131313,0.752626263,0.762121212,0.771616162,0.781111111,	0.790606061,0.80010101,0.80959596,0.819090909,0.828585859,	0.838080808,0.847575758,0.857070707,0.866565657,0.876060606,	0.885555556,0.895050505,0.904545455,0.914040404,0.923535354,	0.933030303,0.942525253,0.952020202,0.961515152,0.971010101,	0.980505051,0.99};

}

double Sample::getMomentumTransverse() {

    double pt, bin;
    int count = 0;

    bin = rand.next();
    for(int i = 0; i < 151; i++) {
        if(momentum_cum1[i] < bin) count++;
    }
    count = count - 1;

    return (bin - momentum_cum1[count]) / (momentum_cum1[count + 1] - momentum_cum1[count]) * 0.1 + 0.1 * count;
}

/// init rand generator with RANLXS0
Sample::Sample(RandomType type)
    :rand(type){}

Sample::~Sample() {
    rand.destroy();
}

ParticleArrayPtr Sample::getParticles(size_t size) {

    ParticleArrayPtr particles(new ParticlePtr[size]);

    double phi, pt, px, py;
    for (int i = 0; i < size; i++) {
        pt = getMomentumTransverse();

        phi = 2 * PI * rand.next();
        px = pt * std::cos(phi);
        py = pt * std::sin(phi);

        particles.get()[i].reset(new Particle(px, py));
    }

    return std::move(particles);
}

}